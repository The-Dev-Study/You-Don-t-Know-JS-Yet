# 3.2 클로저
클로저는 JS를 지탱하는 근본적인 기술이다. 클로저의 존재 혹은 부재가 버그 또는 성능 저하의 원인이 될 수 있으므로 개발자라면 클로저가 어디에 있는지 알아야 한다.

클로저란 함수가 정의된 스코프가 아닌 다른 스코프에서 함수가 실행되더라도, 스코프 밖에 있는 변수를 기억하고 이 외부 변수에 계속 접근할 수 있는 경우를 의미한다.

여기서 클로저만의 특징을 발견할 수 있다. 클로저는 함수의 타고난 특징이다. 객체는 클로저가 되지 않지만, 함수는 자연스럽게 클로저가 된다. 툴째 클러저를 직접 보고 싶다면 함수를 해당 함수가 정의된 스코프가 아닌 다른 스코프에서 실행해야 한다.

``` js 
function greeting(msg) {
    return function who(name) {
        console.log(`${ name }님, ${ msg }!`);
    };
}

var hello = greeting("안녕하세요");
var howdy = greeting("잘 지내시나요");

hello("카일"); // 카일님 안녕하세요
hello("보라"); // 보라님 안녕하세요
howdy("호진"); // 호진님 잘 지내시나요
```

대부분의 개발자는 함수 greeting()이 실행 종료된 후에는 함수에서 사용했던 변수 전체가 GC의 대상이 되어 메모리에서 삭제될 것이라고 예상한다. 따라서 예시에서 첫 번째와 두 번째 greeting()을 호출한 이후에는 msg가 사라질 거라 예상한다. 하지만 변수들은 사라지지 않는다. 바로 클로저 때문이다. 내부 함수 인스턴스들이 hello와 howdy에 각각 할당되면서 아직 살아있고, 이 인스턴스들은 여전히 msg 변수 각각을 에워싸고 있기 때문이다.

클로저는 변수 msg를 복사해서 별도로 만든 값을 사용하지 않는다. 대신 변수 자체와 직접적인 관계를 맺어 변수가 업데이트되는 것을 관찰하고 최신 값을 가져와서 사용한다.

``` js
function counter(step = 1) {
    var count = 0;
    return function increaseCount() {
        count = count + step;
        return count;
    };
}

var incBy1 = counter(1);
var incBy3 = counter(3);

incBy1(); // 1
incBy1(); // 2

incBy3(); // 3
incBy3(); // 6
incBy3(); // 9
```

클로저는 콜백과 같이 비동기 작업을 수행하는 코드에서 가장 흔히 찾아볼 수 있다.

``` js
function getSomeData(url) {
    ajax(url, function onResponse(resp) {
        console.log(
            `${ url }에서 온 응답: ${ resp }`
        );
    });
}

getSomeData("https://some.url/wherever");
```

내부 함수 onResponse()는 url을 에워싸기 때문에 Ajax 호출이 완료되고 그 결과가 onResponse() 콜백 함수에 의해 처리될 때까지 url을 보존하고 기억한다. 이때 getSomeData()가 곧바로 실행 종료되더라도 특별한 이유가 없다면 매개변수 url을 통해 받은 값은 클로저 안에 보존된다.

외부 스코프가 항상 함수여야 하는 건 아니지만 보통 내부 함수에서 하나 이상의 외부 스코프 변수에 접근하려 할 때 클로저를 관찰할 수 있다.
``` js
for (let [idx, btn] of buttons.entries()) {
    btn.addEventListener("click", function onClick() {
        console.log(`${ idx }번째 버튼을 클릭했습니다.`);
    });
}
```

예시에서는 조건식에 쓰일 변수를 정의할 때 let을 사용했으므로 반복이 일어날 때마다 변수 idx와 btn은 새로운 블록 스코프에서 정의된다. 또한 반복문이 실행될 때마다 새로운 내부 함수인 onClick()이 만들어지는데, 이 내부 함수는 idx를 에워싸서 클릭 이벤트 핸들러가 btn에 할당된 동안 idx를 보존한다.

여기서 기억해야 할 중요한 점은 내부 함수는 1이나 3 같은 값을 에워싸는 게 아니라 idx라는 변수 자체를 에워싼다는 점이다.

